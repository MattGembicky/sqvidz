<!DOCTYPE html>
<html lang="cs">
	<head>
		<title>SQVIDZ.io</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
	    <meta name="Content-Language" content="cs">
	    <meta name="Author" content="Matous Gembicky">
	    <meta name="KeyWords" content="squid, game, .io, frined, party">
	    <meta name="Description" content="Try to slap your frined with tentacle">
	    <script src="https://kit.fontawesome.com/53b570c0b2.js" crossorigin="anonymous"></script>
	    <link rel="stylesheet" type="text/css" href="/public/sqvidz.css">
	</head>
	<body onload="dayTime()">
		<div class="gameParts">
			<canvas id="ctx" width="960" height="960"></canvas>
			<div id="chatnlbni-container">
				<h2 style="border-top: 0;background-color: #b00e59;">Leaderboard</h2>
				<div id="lb-box"></div>
				<h2 style="background-color: #046263;">Info</h2>
				<div id="info-box">
					<div id="info-gameType">FFA</div> 
				</div>
				<h2 style="background-color: #634b04;">CHAT</h2>
				<div id="chat-box"></div>
				<form id="chat-form">
					<input id="chat-input" type="text" placeholder="type here">
					<button class="chat-submit submit" type="submit"><i class="fas fa-comment"></i></button>
				</form>
			</div>
		</div>
		<div class="login">
			<h1 class="version">DEVELOPMENT VERSION</h1>
			<div class="logo">
				<h1 class="name-sqvidz" style="left: 50%;transform: translate(-100%,0);">SQV</h1>

					<img class="sqvidTacle" src="" alt="sqvidTacle">
				<h1 class="name-sqvidz">DZ.io</h1>
			</div>
			<div class="login-box">
				<i class="fas fa-question-circle"></i>
				<form id="login-form">
					<input class="name-box" type="text" placeholder="username">
					<input class="name-submit submit" type="submit" value="Play">
				</form>
				<p class="name-border">Make sure that you can see all of the black borders</p>
			</div>
		</div>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
		<script>
			function dayTime() {
				var fullDate = new Date();
				var hoursNow = fullDate.getHours();
				var tentacle = document.getElementsByClassName("sqvidTacle")[0];
				if((hoursNow>=18&&hoursNow<=24)||(hoursNow>=0&&hoursNow<=6))
					tentacle.src ="/public/img/blue_tentacle.png";
				else
					tentacle.src ="/public/img/red_tentacle.png";
			}
			const WIDTH = 960;
			const HEIGHT = 960;

			var Img = {};
			Img.player = new Image();
			Img.logoR = new Image();
			Img.logoB = new Image();
			Img.background = new Image();
			Img.logoR.src = '/public/img/red_tentacle.png';
			Img.logoB.src = '/public/img/blue_tentacle.png';
			Img.player.src = '/public/img/boris.gif';
			Img.background.src = '/public/img/background.png';

			document.getElementById("login-form").onsubmit = function(e){
    			e.preventDefault();
    			var nameBox = document.getElementsByClassName("name-box")[0];
    			socket.emit('usernameIn',nameBox.value);
    			socket.emit('usernameIN',{inputId:'name',state: nameBox.value});
    			document.getElementsByClassName("login")[0].style.display="none";
    			document.getElementsByClassName("gameParts")[0].style.display="block";
    		}
			var socket = io();

			//chat
			var chatInput = document.getElementById("chat-input");
			var chatForm = document.getElementById("chat-form");
			var chatContainer = document.getElementById("chat-box");
    		socket.on('addTextMsg',function(msg){
    			chatContainer.innerHTML += '<div>'+msg+'</div';
  					chatContainer.scrollTo(0,Number.MAX_SAFE_INTEGER);
    		});

    		socket.on('evalServer',function(data){
    			console.log(data);
    		});

    		chatForm.onsubmit = function(e){
    			e.preventDefault();
    			if(chatInput.value[0]!=='/')
    				socket.emit('MsgToServer',chatInput.value);//msg
    			else
    				socket.emit('evalServer',chatInput.value.slice(1));//eval
    			chatInput.value = '';
    		}

			

			//init
			var ctx = document.getElementById("ctx").getContext("2d");
    		ctx.font = '30px Arial';

    		var Player = function(initPack){
		        var self = {};
		        self.id = initPack.id;
		        self.name = initPack.name;
		        self.x = initPack.x;
		        self.y = initPack.y;
		        self.score = initPack.score;

		        self.draw = function(){
		        	var width = 64;
		        	var height = 64;
		        	ctx.font = '16px Arial'
		        	ctx.fillText(self.name,self.x-16,self.y-28)
		        	/*var widthOfP = Img.player.width*2;
		        	var heightOfP = Img.player.height*2;*/
		        	ctx.drawImage(Img.player,
		        		0,0,Img.player.width,Img.player.height,
		        		self.x-width/2,self.y-height/2,width,height);
		        }

		        Player.list[self.id] = self;
		        return self;
		    }
		    Player.list = {};
		 	
			var selfId = null; 

		    socket.on('init',function(data){  
		    	if(data.selfId)
		    		selfId = data.selfId;
		        //{ player : [{id:123,number:'1',x:0,y:0},{id:1,number:'2',x:0,y:0}], bullet: []}
		        for(var i = 0 ; i < data.player.length; i++){
		            new Player(data.player[i]);
		        }
		    });
		   
		    socket.on('update',function(data){
		        //{ player : [{id:123,x:0,y:0},{id:1,x:0,y:0}], bullet: []}
		        for(var i = 0; i < data.player.length; i++){
		            var pack = data.player[i];
		            var p = Player.list[pack.id];
		            if(p){
		                if(pack.x !== undefined)
		                    p.x = pack.x;
		                if(pack.y !== undefined)
		                    p.y = pack.y;
		                if(pack.score !== undefined)
		                    p.score = pack.score;
		            }
		        }
		        leaderupdate(data);
		    });
		    var leaderupdate = function(data){
		    	var lbBox = document.getElementById("lb-box");

		    	var lbScore = [];

		    	for(var i = 0; i < data.player.length; i++){
		            var pack = data.player[i];
		            lbScore[i] = pack.score;
		        }
		        lbScore = lbScore.sort(function(a, b){return b-a});

		        var text = "";
		       	for(var k = 0; k < 10 || k < lbScore.length; k++){
		       		var usedNames = [];
			        for(var i = 0; i < data.player.length; i++){
				        var pack = data.player[i];
				        if(lbScore[k]===pack.score&&pack.name!==usedNames[k-1]){
				            text += (k+1)+'. '+pack.name;
				            for(var ii = 1; ii < (10-pack.name.length); ii++)
				            	text += '..';
				            text += pack.score+'<br>';
				            break;
				            usedNames[k]=pack.name;
				        }
			        }
			    }
		    	lbBox.innerHTML = text;
		    }

		   
		    socket.on('remove',function(data){
		        //{player:[12323],bullet:[12323,123123]}
		        for(var i = 0 ; i < data.player.length; i++){
		            delete Player.list[data.player[i]];
		        }
		    });
		   	
		    setInterval(function(){
		        ctx.clearRect(0,0,WIDTH,HEIGHT);
		        ctx.drawImage(Img.background,0,0);
		        drawScore();
		        for(var i in Player.list)
		          	Player.list[i].draw();  
		    },1000/60);		//game speed

		    var drawScore = function(){
		    	ctx.font = '24px Arial';
		    	ctx.fillStyle = 'white';
		    	ctx.fillText(Player.list[selfId].score,18,HEIGHT-20);
		    }


    		//game movement
			document.onkeydown = function(event){	//if key pressed
				if(event.keyCode === 68 || event.keyCode === 39)	//Dkey or Rarrow
					socket.emit('keyPress',{inputId:'right',state: true});
				if(event.keyCode === 65 || event.keyCode === 37)	//Akey or Larrow
					socket.emit('keyPress',{inputId:'left',state: true});
				if(event.keyCode === 87 || event.keyCode === 38)	//Wkey or Uarrow
					socket.emit('keyPress',{inputId:'up',state: true});
				if(event.keyCode === 83 || event.keyCode === 40)	//Skey or Darrow
					socket.emit('keyPress',{inputId:'down',state: true});
				if(event.keyCode === 32)							//Spacebar
					socket.emit('keyPress',{inputId:'space',state: true});
			}
			document.onkeyup = function(event){	//if key released
				if(event.keyCode === 68 || event.keyCode === 39)	//Dkey or Rarrow
					socket.emit('keyPress',{inputId:'right',state: false});
				if(event.keyCode === 65 || event.keyCode === 37)	//Akey or Larrow
					socket.emit('keyPress',{inputId:'left',state: false});
				if(event.keyCode === 87 || event.keyCode === 38)	//Wkey or Uarrow
					socket.emit('keyPress',{inputId:'up',state: false});
				if(event.keyCode === 83 || event.keyCode === 40)	//Skey or Darrow
					socket.emit('keyPress',{inputId:'down',state: false});
				if(event.keyCode === 32)						//Spacebar
					socket.emit('keyPress',{inputId:'space',state: false});
			}
		</script>
	</body>
</html>